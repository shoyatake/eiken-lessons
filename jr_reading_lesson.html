<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­å­¦ç”Ÿè‹±æ¤œ èª­æ›¸ï¼†éŸ³èª­ãƒ¬ãƒƒã‚¹ãƒ³</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      h2 {
        margin-top: 0;
      }
      .section {
        background: #fff;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .flex {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        background: #0073aa;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #005f8a;
      }
      input[type="range"] {
        vertical-align: middle;
      }
      label {
        margin-right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: #f0f0f0;
      }
      .output {
        background: #eef9ff;
        padding: 0.5rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
      ol {
        padding-left: 1.5rem;
      }
      ol li {
        margin-bottom: 0.3rem;
      }
    </style>
  </head>
  <body>
    <h1>ä¸­å­¦ç”Ÿè‹±æ¤œ èª­æ›¸ï¼†éŸ³èª­ãƒ¬ãƒƒã‚¹ãƒ³</h1>
    <div class="section">
      <label for="lessonSelect">ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠ:</label>
      <select id="lessonSelect"></select>
    </div>
    <div class="section" id="lessonArea">
      <h2 id="lessonTitle"></h2>
      <div id="sentences"></div>
      <label><input type="checkbox" id="toggleTranslation" /> æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤ºã™ã‚‹</label>
    </div>
    <div class="section" id="practiceArea">
      <h3>éŸ³èª­ãƒ»èª­è§£ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
      <p>ä¸‹ã®æ‰‹é †ã«æ²¿ã£ã¦èª­è§£ã¨éŸ³èª­ã®ç·´ç¿’ã‚’é€²ã‚ã¾ã—ã‚‡ã†ã€‚</p>
      <ol>
        <li>çŸ­æ–‡ã‚’éŸ³èª­ã—ã€éŒ²éŸ³ã—ã¾ã—ã‚‡ã†ï¼ˆğŸ¤ <strong>ã¾ãšèª­ã‚“ã§ã¿ã‚‹</strong>ï¼‰ã€‚</li>
        <li>é‡è¦å˜èªã‚’ç¢ºèªã—ã€æ„å‘³ã‚’è¦šãˆã¾ã—ã‚‡ã†ã€‚</li>
        <li>æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤ºã—ã¦ã€ç²¾èª­ã—ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</li>
        <li>éŸ³å£°ã‚’è´ã„ã¦ãƒªã‚ºãƒ ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚</li>
        <li>ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ç·´ç¿’ï¼ˆğŸ§ <strong>ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</strong>ï¼‰ã€‚</li>
        <li>éŸ³å£°é€Ÿåº¦ã‚’ä¸Šã’ã¦ç¹°ã‚Šè¿”ã—ã¾ã—ã‚‡ã†ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´ï¼‰ã€‚</li>
        <li>ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°ï¼ˆğŸ§ <strong>ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°</strong>ï¼‰ã€‚</li>
        <li>æœ€å¾Œã«ã‚‚ã†ä¸€åº¦éŸ³èª­ã—ã¦éŒ²éŸ³ã—ã€é€²æ­©ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼ˆğŸ“– <strong>æœ€å¾Œã«èª­ã‚€</strong>ï¼‰ã€‚</li>
      </ol>
      <div class="flex">
        <button id="firstReadBtn">ğŸ¤ ã¾ãšèª­ã‚“ã§ã¿ã‚‹</button>
        <button id="shadowBtn">ğŸ§ ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</button>
        <button id="overlapBtn">ğŸ§ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°</button>
        <button id="finalReadBtn">ğŸ“– æœ€å¾Œã«èª­ã‚€</button>
      </div>
      <div class="flex">
        <label>éŸ³å£°é€Ÿåº¦ <input type="range" id="rateSlider" min="0.6" max="1.4" step="0.1" value="1" /></label>
        <label>éŸ³å£°ã‚¿ã‚¤ãƒ—
          <select id="voiceSelect"></select>
        </label>
      </div>
      <div id="firstOutput" class="output" style="display:none;"></div>
      <div id="finalOutput" class="output" style="display:none;"></div>
      <div id="improvement" class="output" style="display:none;"></div>
    </div>
    <div class="section" id="vocabArea">
      <h3>èªå½™</h3>
      <button id="flipVocab">è‹±â‡”æ—¥ åè»¢</button>
      <table id="vocabTable"></table>
    </div>
    <div class="section">
      <h3>è‡ªå·±æ¡ç‚¹</h3>
      <label>æ­£è§£æ•°: <input type="number" id="scoreInput" min="0" /></label>
      <button id="saveCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="sendForm">Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡</button>
      <input type="text" id="formUrl" placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã®URL (formResponse)" style="width:100%;margin-top:0.5rem;" />
    </div>
    <script>
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒƒã‚¹ãƒ³ãƒ‡ãƒ¼ã‚¿ã€‚å„ãƒ¬ãƒƒã‚¹ãƒ³ã¯æ–‡ç« ã¨èªå½™ã‚’å«ã¿ã¾ã™ã€‚
      const LESSONS = [
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³1',
          sentences: [
            { en: 'Reading English every day improves your skills.', jp: 'è‹±èªã‚’æ¯æ—¥èª­ã‚€ã“ã¨ã§ã‚¹ã‚­ãƒ«ãŒå‘ä¸Šã—ã¾ã™ã€‚' },
            { en: 'Practice makes perfect.', jp: 'ç·´ç¿’ã¯å®Œç’§ã‚’ä½œã‚‹ã€‚' },
            { en: 'Listen carefully and repeat.', jp: 'ã‚ˆãèã„ã¦ç¹°ã‚Šè¿”ã—ã¦ãã ã•ã„ã€‚' },
          ],
          vocab: [
            ['improve', 'å‘ä¸Šã™ã‚‹'],
            ['practice', 'ç·´ç¿’'],
            ['perfect', 'å®Œç’§'],
            ['carefully', 'æ³¨æ„æ·±ã'],
            ['repeat', 'ç¹°ã‚Šè¿”ã™'],
          ],
        },
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³2',
          sentences: [
            { en: 'Shadowing helps improve your pronunciation.', jp: 'ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã¯ç™ºéŸ³ã‚’å‘ä¸Šã•ã›ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚' },
            { en: 'Overlapping trains your rhythm and fluency.', jp: 'ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã¯ãƒªã‚ºãƒ ã¨æµæš¢ã•ã‚’é›ãˆã¾ã™ã€‚' },
            { en: 'You can do it!', jp: 'ã‚ãªãŸãªã‚‰ã§ãã¾ã™ï¼' },
          ],
          vocab: [
            ['shadowing', 'ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°'],
            ['pronunciation', 'ç™ºéŸ³'],
            ['overlapping', 'ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°'],
            ['rhythm', 'ãƒªã‚ºãƒ '],
            ['fluency', 'æµæš¢ã•'],
          ],
        },
        // è¿½åŠ ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¯å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«å®šç¾©ã—ã¦ãã ã•ã„ã€‚
      ];

      // å¿…è¦ã«å¿œã˜ã¦15ãƒ¬ãƒƒã‚¹ãƒ³ã¾ã§ã‚³ãƒ”ãƒ¼ã§å¢—ã‚„ã™
      while (LESSONS.length < 15) {
        const base = JSON.parse(JSON.stringify(LESSONS[LESSONS.length % 2]));
        base.title = `ãƒ¬ãƒƒã‚¹ãƒ³${LESSONS.length + 1}`;
        LESSONS.push(base);
      }

      let expectedText = '';
      let firstTranscript = '';
      let finalTranscript = '';
      let firstAccuracy = null;
      let finalAccuracy = null;

      const lessonSelect = document.getElementById('lessonSelect');
      const lessonTitle = document.getElementById('lessonTitle');
      const sentencesEl = document.getElementById('sentences');
      const toggleTranslation = document.getElementById('toggleTranslation');
      const flipVocab = document.getElementById('flipVocab');
      const vocabTable = document.getElementById('vocabTable');
      const rateSlider = document.getElementById('rateSlider');
      const voiceSelect = document.getElementById('voiceSelect');
      const firstReadBtn = document.getElementById('firstReadBtn');
      const finalReadBtn = document.getElementById('finalReadBtn');
      const shadowBtn = document.getElementById('shadowBtn');
      const overlapBtn = document.getElementById('overlapBtn');
      const firstOutput = document.getElementById('firstOutput');
      const finalOutput = document.getElementById('finalOutput');
      const improvement = document.getElementById('improvement');
      const scoreInput = document.getElementById('scoreInput');
      const saveCsv = document.getElementById('saveCsv');
      const sendForm = document.getElementById('sendForm');
      const formUrl = document.getElementById('formUrl');

      // Populate lesson dropdown
      LESSONS.forEach((lesson, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = lesson.title;
        lessonSelect.appendChild(option);
      });

      // Load voices for TTS
      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach((voice, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = `${voice.lang} - ${voice.name}`;
          voiceSelect.appendChild(option);
        });
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }

      function renderLesson() {
        const lesson = LESSONS[parseInt(lessonSelect.value)];
        lessonTitle.textContent = lesson.title;
        sentencesEl.innerHTML = '';
        expectedText = '';
        lesson.sentences.forEach((sent) => {
          const p = document.createElement('p');
          p.innerHTML = `<span class="en">${sent.en}</span> <span class="jp" style="display:none;">${sent.jp}</span>`;
          sentencesEl.appendChild(p);
          expectedText += sent.en + ' ';
        });
        renderVocab();
        firstOutput.style.display = 'none';
        finalOutput.style.display = 'none';
        improvement.style.display = 'none';
      }

      function toggleTranslations() {
        const show = toggleTranslation.checked;
        document.querySelectorAll('#sentences .jp').forEach((span) => {
          span.style.display = show ? 'inline' : 'none';
        });
      }

      function renderVocab() {
        const lesson = LESSONS[parseInt(lessonSelect.value)];
        vocabTable.innerHTML = '';
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const firstHead = document.createElement('th');
        const secondHead = document.createElement('th');
        if (flipVocab.dataset.flipped === 'true') {
          firstHead.textContent = 'æ—¥æœ¬èª';
          secondHead.textContent = 'è‹±èª';
        } else {
          firstHead.textContent = 'è‹±èª';
          secondHead.textContent = 'æ—¥æœ¬èª';
        }
        headerRow.appendChild(firstHead);
        headerRow.appendChild(secondHead);
        thead.appendChild(headerRow);
        vocabTable.appendChild(thead);
        const tbody = document.createElement('tbody');
        lesson.vocab.forEach((word) => {
          const tr = document.createElement('tr');
          if (flipVocab.dataset.flipped === 'true') {
            tr.innerHTML = `<td>${word[1]}</td><td>${word[0]}</td>`;
          } else {
            tr.innerHTML = `<td>${word[0]}</td><td>${word[1]}</td>`;
          }
          tbody.appendChild(tr);
        });
        vocabTable.appendChild(tbody);
      }

      function speakLesson(rate) {
        const utterance = new SpeechSynthesisUtterance(expectedText.trim());
        const selectedVoice = speechSynthesis.getVoices()[parseInt(voiceSelect.value)];
        if (selectedVoice) utterance.voice = selectedVoice;
        utterance.rate = rate;
        speechSynthesis.speak(utterance);
      }

      function recordReading(stage) {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const accuracy = calculateAccuracy(transcript, expectedText);
          if (stage === 'first') {
            firstTranscript = transcript;
            firstAccuracy = accuracy;
            firstOutput.style.display = 'block';
            firstOutput.textContent = `æœ€åˆã®èª­ã¿: ${transcript}\nä¸€è‡´ç‡: ${(accuracy * 100).toFixed(2)}%`;
          } else {
            finalTranscript = transcript;
            finalAccuracy = accuracy;
            finalOutput.style.display = 'block';
            finalOutput.textContent = `æœ€å¾Œã®èª­ã¿: ${transcript}\nä¸€è‡´ç‡: ${(accuracy * 100).toFixed(2)}%`;
            improvement.style.display = 'block';
            if (firstAccuracy != null) {
              const diff = ((finalAccuracy - firstAccuracy) * 100).toFixed(2);
              improvement.textContent = `æ”¹å–„ç‡: ${diff}%`;
            } else {
              improvement.textContent = '';
            }
          }
        };
        recognition.onerror = (event) => {
          alert('éŸ³å£°èªè­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error);
        };
        recognition.start();
      }

      function calculateAccuracy(transcript, reference) {
        const t = transcript.trim().toLowerCase().split(/\s+/);
        const r = reference.trim().toLowerCase().split(/\s+/);
        const len = Math.max(t.length, r.length);
        let matches = 0;
        for (let i = 0; i < len; i++) {
          if (t[i] === r[i]) matches++;
        }
        return matches / len;
      }

      function saveCsvFile() {
        const date = new Date().toISOString();
        const lesson = LESSONS[parseInt(lessonSelect.value)].title;
        const score = scoreInput.value || '';
        const rows = [
          ['date', 'lesson', 'score', 'first_transcript', 'first_accuracy', 'final_transcript', 'final_accuracy'],
          [date, lesson, score, firstTranscript, firstAccuracy ?? '', finalTranscript, finalAccuracy ?? ''],
        ];
        const csvContent = rows.map((r) => r.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reading_lesson_score_${Date.now()}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function sendToForm() {
        const url = formUrl.value.trim();
        if (!url) {
          alert('Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        const data = new FormData();
        data.append('entry.lesson', LESSONS[parseInt(lessonSelect.value)].title);
        data.append('entry.score', scoreInput.value);
        data.append('entry.date', new Date().toISOString());
        data.append('entry.firstTranscript', firstTranscript);
        data.append('entry.firstAccuracy', firstAccuracy ?? '');
        data.append('entry.finalTranscript', finalTranscript);
        data.append('entry.finalAccuracy', finalAccuracy ?? '');
        fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          body: data,
        })
          .then(() => alert('ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸã€‚'))
          .catch(() => alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      }

      // Event listeners
      lessonSelect.addEventListener('change', renderLesson);
      toggleTranslation.addEventListener('change', toggleTranslations);
      flipVocab.addEventListener('click', () => {
        flipVocab.dataset.flipped = flipVocab.dataset.flipped === 'true' ? 'false' : 'true';
        renderVocab();
      });
      saveCsv.addEventListener('click', saveCsvFile);
      sendForm.addEventListener('click', sendToForm);
      firstReadBtn.addEventListener('click', () => recordReading('first'));
      finalReadBtn.addEventListener('click', () => recordReading('final'));
      shadowBtn.addEventListener('click', () => speakLesson(parseFloat(rateSlider.value)));
      overlapBtn.addEventListener('click', () => speakLesson(parseFloat(rateSlider.value)));

      // Initial render
      lessonSelect.value = 0;
      renderLesson();
    </script>
  </body>
</html>