<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­å­¦ç”Ÿã®ãŸã‚ã®è‹±æ¤œãƒ¬ãƒƒã‚¹ãƒ³</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      select, button, input, label {
        margin: 0.5rem 0;
        padding: 0.5rem;
        font-size: 1rem;
      }
      .section {
        background: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .sentence {
        margin-bottom: 0.5rem;
      }
      .translation {
        color: #888;
        margin-left: 1rem;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
      .flex {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>è‹±æ¤œå¤šèª­å¤šè´ãƒ¬ãƒƒã‚¹ãƒ³</h1>
    <div class="section">
      <label for="lessonSelect">ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠ:</label>
      <select id="lessonSelect"></select>
    </div>
    <div class="section" id="lessonArea">
      <h2 id="lessonTitle"></h2>
      <div id="sentences"></div>
      <label><input type="checkbox" id="toggleTranslation" /> æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤ºã™ã‚‹</label>
    </div>
    <div class="section" id="vocabArea">
      <h3>èªå½™</h3>
      <button id="flipVocab">è‹±â‡”æ—¥ åè»¢</button>
      <table id="vocabTable"></table>
    </div>
    <div class="section">
      <h3>ç™ºéŸ³ç·´ç¿’</h3>
      <p>æ–‡ç« ã‚’å†ç”Ÿã—ã€éŒ²éŸ³ã—ã¦ä¸€è‡´åº¦ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
      <div class="flex">
        <label>éŸ³å£°é€Ÿåº¦ <input type="range" id="rateSlider" min="0.6" max="1.4" step="0.1" value="1" /></label>
        <label>éŸ³å£°ã‚¿ã‚¤ãƒ—
          <select id="voiceSelect"></select>
        </label>
      </div>
    </div>
    <div class="section">
      <h3>è‡ªå·±æ¡ç‚¹</h3>
      <label>æ­£è§£æ•°: <input type="number" id="scoreInput" min="0" /></label>
      <button id="saveCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="sendForm">Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡</button>
      <input type="text" id="formUrl" placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã®URL (formResponse)" style="width:100%;margin-top:0.5rem;" />
    </div>
    <script>
      // 15ãƒ¬ãƒƒã‚¹ãƒ³åˆ†ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã§ãã¾ã™ã€‚
      const LESSONS = [
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³1',
          sentences: [
            { en: 'I like apples.', jp: 'ç§ã¯ã‚Šã‚“ã”ãŒå¥½ãã§ã™ã€‚' },
            { en: 'He plays soccer every day.', jp: 'å½¼ã¯æ¯æ—¥ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã™ã€‚' },
            { en: 'We study English at school.', jp: 'ç§ãŸã¡ã¯å­¦æ ¡ã§è‹±èªã‚’å‹‰å¼·ã—ã¾ã™ã€‚' },
          ],
          vocab: [
            ['apple', 'ã‚Šã‚“ã”'],
            ['like', 'å¥½ã'],
            ['play', 'éŠã¶ï¼ã™ã‚‹'],
            ['soccer', 'ã‚µãƒƒã‚«ãƒ¼'],
            ['study', 'å‹‰å¼·ã™ã‚‹'],
            ['school', 'å­¦æ ¡'],
          ],
        },
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³2',
          sentences: [
            { en: 'She reads books.', jp: 'å½¼å¥³ã¯æœ¬ã‚’èª­ã¿ã¾ã™ã€‚' },
            { en: 'They watch TV at night.', jp: 'å½¼ã‚‰ã¯å¤œã«ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã™ã€‚' },
            { en: 'Do you like sushi?', jp: 'ã‚ãªãŸã¯å¯¿å¸ãŒå¥½ãã§ã™ã‹ï¼Ÿ' },
          ],
          vocab: [
            ['read', 'èª­ã‚€'],
            ['book', 'æœ¬'],
            ['watch', 'è¦‹ã‚‹'],
            ['night', 'å¤œ'],
            ['sushi', 'å¯¿å¸'],
            ['like', 'å¥½ã'],
          ],
        },
        // ä»¥ä¸‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¯åŒã˜æ§‹é€ ã§ç°¡å˜ãªå†…å®¹ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
        // ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹éš›ã¯ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
      ];
      // è‡ªå‹•ã§15ãƒ¬ãƒƒã‚¹ãƒ³ã«ã™ã‚‹ï¼ˆä¸è¶³åˆ†ã¯ã‚³ãƒ”ãƒ¼ã—ã¦åŸ‹ã‚ã‚‹ï¼‰
      while (LESSONS.length < 15) {
        const base = JSON.parse(JSON.stringify(LESSONS[LESSONS.length % 2]));
        base.title = `ãƒ¬ãƒƒã‚¹ãƒ³${LESSONS.length + 1}`;
        LESSONS.push(base);
      }

      const lessonSelect = document.getElementById('lessonSelect');
      const lessonTitle = document.getElementById('lessonTitle');
      const sentencesEl = document.getElementById('sentences');
      const vocabTable = document.getElementById('vocabTable');
      const toggleTranslation = document.getElementById('toggleTranslation');
      const flipVocab = document.getElementById('flipVocab');
      const rateSlider = document.getElementById('rateSlider');
      const voiceSelect = document.getElementById('voiceSelect');
      const scoreInput = document.getElementById('scoreInput');
      const saveCsv = document.getElementById('saveCsv');
      const sendForm = document.getElementById('sendForm');
      const formUrl = document.getElementById('formUrl');

      // Populate lesson dropdown
      LESSONS.forEach((lesson, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = lesson.title;
        lessonSelect.appendChild(option);
      });

      // Load voices for TTS
      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach((voice, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = `${voice.lang} - ${voice.name}`;
          voiceSelect.appendChild(option);
        });
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }

      // Helper: speak text
      function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          const selected = voiceSelect.value;
          utter.voice = voices[selected] || null;
        }
        utter.rate = parseFloat(rateSlider.value);
        speechSynthesis.speak(utter);
      }

      // Helper: record and check pronunciation
      function recordAndCheck(expected) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const accuracy = calculateAccuracy(expected, transcript);
          alert(`èªè­˜çµæœ: ${transcript}\nä¸€è‡´åº¦: ${accuracy}%`);
        };
        recognition.onerror = (event) => {
          alert('éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error);
        };
        recognition.start();
      }

      function calculateAccuracy(expected, recognized) {
        const normalize = (str) => str.toLowerCase().replace(/[^a-z\s]/g, '').split(/\s+/).filter(Boolean);
        const expectedWords = normalize(expected);
        const recognizedWords = normalize(recognized);
        let matches = 0;
        expectedWords.forEach((w, i) => {
          if (recognizedWords[i] && recognizedWords[i] === w) matches++;
        });
        return Math.round((matches / expectedWords.length) * 100);
      }

      // Render selected lesson
      function renderLesson() {
        const idx = parseInt(lessonSelect.value);
        const lesson = LESSONS[idx];
        lessonTitle.textContent = lesson.title;
        // sentences
        sentencesEl.innerHTML = '';
        lesson.sentences.forEach((sent) => {
          const div = document.createElement('div');
          div.className = 'sentence';
          const spanEn = document.createElement('span');
          spanEn.textContent = sent.en;
          const playBtn = document.createElement('button');
          playBtn.textContent = 'â–¶ï¸';
          playBtn.onclick = () => speak(sent.en);
          const recordBtn = document.createElement('button');
          recordBtn.textContent = 'ğŸ™ï¸';
          recordBtn.onclick = () => recordAndCheck(sent.en);
          const spanJp = document.createElement('span');
          spanJp.className = 'translation';
          spanJp.textContent = sent.jp;
          div.appendChild(playBtn);
          div.appendChild(recordBtn);
          div.appendChild(spanEn);
          div.appendChild(spanJp);
          sentencesEl.appendChild(div);
        });
        toggleTranslation.checked = false;
        toggleTranslations();
        renderVocab();
      }

      function toggleTranslations() {
        const show = toggleTranslation.checked;
        document.querySelectorAll('.translation').forEach((el) => {
          el.style.display = show ? 'inline' : 'none';
        });
      }

      function renderVocab() {
        const idx = parseInt(lessonSelect.value);
        const vocab = LESSONS[idx].vocab;
        const flipped = flipVocab.dataset.flipped === 'true';
        vocabTable.innerHTML = '';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        const th1 = document.createElement('th');
        const th2 = document.createElement('th');
        th1.textContent = flipped ? 'æ—¥æœ¬èª' : 'è‹±èª';
        th2.textContent = flipped ? 'è‹±èª' : 'æ—¥æœ¬èª';
        trh.appendChild(th1);
        trh.appendChild(th2);
        thead.appendChild(trh);
        vocabTable.appendChild(thead);
        const tbody = document.createElement('tbody');
        vocab.forEach((pair) => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          const td2 = document.createElement('td');
          td1.textContent = flipped ? pair[1] : pair[0];
          td2.textContent = flipped ? pair[0] : pair[1];
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        });
        vocabTable.appendChild(tbody);
      }

      function saveCsvFile() {
        const date = new Date().toISOString();
        const lesson = LESSONS[parseInt(lessonSelect.value)].title;
        const score = scoreInput.value || '';
        const rows = [['date', 'lesson', 'score'], [date, lesson, score]];
        const csvContent = rows.map((r) => r.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `score_${Date.now()}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function sendToForm() {
        const url = formUrl.value.trim();
        if (!url) {
          alert('Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        const data = new FormData();
        data.append('entry.lesson', LESSONS[parseInt(lessonSelect.value)].title);
        data.append('entry.score', scoreInput.value);
        data.append('entry.date', new Date().toISOString());
        fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          body: data,
        })
          .then(() => alert('ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸã€‚'))
          .catch(() => alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      }

      lessonSelect.addEventListener('change', renderLesson);
      toggleTranslation.addEventListener('change', toggleTranslations);
      flipVocab.addEventListener('click', () => {
        flipVocab.dataset.flipped = flipVocab.dataset.flipped === 'true' ? 'false' : 'true';
        renderVocab();
      });
      saveCsv.addEventListener('click', saveCsvFile);
      sendForm.addEventListener('click', sendToForm);

      // åˆæœŸè¡¨ç¤º
      lessonSelect.value = 0;
      renderLesson();
    </script>
  </body>
</html>