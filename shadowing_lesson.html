<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‹±æ¤œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ï¼†éŸ³èª­ãƒ¬ãƒƒã‚¹ãƒ³</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.5;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      h2 {
        margin-top: 0;
      }
      select,
      button,
      input,
      label {
        margin: 0.5rem 0;
        padding: 0.5rem;
        font-size: 1rem;
      }
      .section {
        background: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .sentence {
        margin-bottom: 0.5rem;
      }
      .translation {
        color: #888;
        margin-left: 1rem;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
      .flex {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .output {
        background: #eef9ff;
        padding: 0.5rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <h1>è‹±æ¤œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ï¼†éŸ³èª­ãƒ¬ãƒƒã‚¹ãƒ³</h1>
    <div class="section">
      <label for="lessonSelect">ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠ:</label>
      <select id="lessonSelect"></select>
    </div>
    <div class="section" id="lessonArea">
      <h2 id="lessonTitle"></h2>
      <div id="sentences"></div>
      <label><input type="checkbox" id="toggleTranslation" /> æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤ºã™ã‚‹</label>
    </div>
    <div class="section" id="practiceArea">
      <h3>éŸ³èª­ &amp; ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ç·´ç¿’</h3>
      <p>ã¾ãšæ–‡ç« ã‚’èª­ã‚“ã§éŒ²éŸ³ã—ã¾ã—ã‚‡ã†ã€‚ç²¾èª­ã‚„ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã§ç·´ç¿’ã—ãŸå¾Œã€ã‚‚ã†ä¸€åº¦èª­ã‚“ã§æˆé•·ã‚’å®Ÿæ„Ÿã—ã¦ãã ã•ã„ã€‚</p>
      <div class="flex">
        <button id="firstReadBtn">ğŸ¤ ã¾ãšèª­ã‚“ã§ã¿ã‚‹</button>
        <button id="shadowBtn">ğŸ§ ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</button>
        <button id="overlapBtn">ğŸ§ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°</button>
        <button id="finalReadBtn">ğŸ“– æœ€å¾Œã«èª­ã‚€</button>
      </div>
      <div class="flex">
        <label>éŸ³å£°é€Ÿåº¦ <input type="range" id="rateSlider" min="0.6" max="1.4" step="0.1" value="1" /></label>
        <label>éŸ³å£°ã‚¿ã‚¤ãƒ—
          <select id="voiceSelect"></select>
        </label>
      </div>
      <div id="firstOutput" class="output" style="display:none;"></div>
      <div id="finalOutput" class="output" style="display:none;"></div>
      <div id="improvement" class="output" style="display:none;"></div>
    </div>
    <div class="section" id="vocabArea">
      <h3>èªå½™</h3>
      <button id="flipVocab">è‹±â‡”æ—¥ åè»¢</button>
      <table id="vocabTable"></table>
    </div>
    <div class="section">
      <h3>è‡ªå·±æ¡ç‚¹</h3>
      <label>æ­£è§£æ•°: <input type="number" id="scoreInput" min="0" /></label>
      <button id="saveCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="sendForm">Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡</button>
      <input type="text" id="formUrl" placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã®URL (formResponse)" style="width:100%;margin-top:0.5rem;" />
    </div>
    <script>
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒƒã‚¹ãƒ³ãƒ‡ãƒ¼ã‚¿ã€‚å„ãƒ¬ãƒƒã‚¹ãƒ³ã¯æ–‡ç« ã¨èªå½™ã‚’å«ã¿ã¾ã™ã€‚
      const LESSONS = [
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³1',
          sentences: [
            { en: 'Learning English is fun and rewarding.', jp: 'è‹±èªã‚’å­¦ã¶ã“ã¨ã¯æ¥½ã—ãã€ã‚„ã‚ŠãŒã„ãŒã‚ã‚Šã¾ã™ã€‚' },
            { en: 'Practice makes perfect.', jp: 'ç·´ç¿’ã¯å®Œç’§ã‚’ä½œã‚‹ã€‚' },
            { en: 'Listen carefully and repeat.', jp: 'ã‚ˆãèã„ã¦ç¹°ã‚Šè¿”ã—ã¦ãã ã•ã„ã€‚' },
          ],
          vocab: [
            ['rewarding', 'ã‚„ã‚ŠãŒã„ã®ã‚ã‚‹'],
            ['practice', 'ç·´ç¿’'],
            ['perfect', 'å®Œç’§'],
            ['listen', 'èã'],
            ['repeat', 'ç¹°ã‚Šè¿”ã™'],
          ],
        },
        {
          title: 'ãƒ¬ãƒƒã‚¹ãƒ³2',
          sentences: [
            { en: 'Shadowing helps improve your pronunciation.', jp: 'ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã¯ç™ºéŸ³ã‚’å‘ä¸Šã•ã›ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚' },
            { en: 'Overlapping trains your rhythm and fluency.', jp: 'ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã¯ãƒªã‚ºãƒ ã¨æµæš¢ã•ã‚’é›ãˆã¾ã™ã€‚' },
            { en: 'You can do it!', jp: 'ã‚ãªãŸãªã‚‰ã§ãã¾ã™ï¼' },
          ],
          vocab: [
            ['shadowing', 'ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°'],
            ['pronunciation', 'ç™ºéŸ³'],
            ['overlapping', 'ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ”ãƒ³ã‚°'],
            ['rhythm', 'ãƒªã‚ºãƒ '],
            ['fluency', 'æµæš¢ã•'],
          ],
        },
        // è¿½åŠ ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¯å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«å®šç¾©ã—ã¦ãã ã•ã„ã€‚
      ];

      // å¿…è¦ã«å¿œã˜ã¦15ãƒ¬ãƒƒã‚¹ãƒ³ã¾ã§ã‚³ãƒ”ãƒ¼ã§å¢—ã‚„ã™
      while (LESSONS.length < 15) {
        const base = JSON.parse(JSON.stringify(LESSONS[LESSONS.length % 2]));
        base.title = `ãƒ¬ãƒƒã‚¹ãƒ³${LESSONS.length + 1}`;
        LESSONS.push(base);
      }

      let expectedText = '';
      let firstTranscript = '';
      let finalTranscript = '';
      let firstAccuracy = null;
      let finalAccuracy = null;

      const lessonSelect = document.getElementById('lessonSelect');
      const lessonTitle = document.getElementById('lessonTitle');
      const sentencesEl = document.getElementById('sentences');
      const toggleTranslation = document.getElementById('toggleTranslation');
      const flipVocab = document.getElementById('flipVocab');
      const vocabTable = document.getElementById('vocabTable');
      const rateSlider = document.getElementById('rateSlider');
      const voiceSelect = document.getElementById('voiceSelect');
      const firstReadBtn = document.getElementById('firstReadBtn');
      const finalReadBtn = document.getElementById('finalReadBtn');
      const shadowBtn = document.getElementById('shadowBtn');
      const overlapBtn = document.getElementById('overlapBtn');
      const firstOutput = document.getElementById('firstOutput');
      const finalOutput = document.getElementById('finalOutput');
      const improvement = document.getElementById('improvement');
      const scoreInput = document.getElementById('scoreInput');
      const saveCsv = document.getElementById('saveCsv');
      const sendForm = document.getElementById('sendForm');
      const formUrl = document.getElementById('formUrl');

      // Populate lesson dropdown
      LESSONS.forEach((lesson, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = lesson.title;
        lessonSelect.appendChild(option);
      });

      // Load voices for TTS
      function populateVoices() {
        const voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach((voice, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = `${voice.lang} - ${voice.name}`;
          voiceSelect.appendChild(option);
        });
      }
      populateVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
      }

      // Speak a text
      function speak(text, rateOverride) {
        const utter = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
          const selected = voiceSelect.value;
          utter.voice = voices[selected] || null;
        }
        utter.rate = rateOverride || parseFloat(rateSlider.value);
        speechSynthesis.speak(utter);
      }

      // Speak the whole lesson sequentially
      function speakLesson(rateOverride) {
        const fullText = LESSONS[parseInt(lessonSelect.value)].sentences
          .map((s) => s.en)
          .join(' ');
        speak(fullText, rateOverride);
      }

      // Record reading and calculate accuracy
      function recordReading(stage) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const accuracy = calculateAccuracy(expectedText, transcript);
          if (stage === 'first') {
            firstTranscript = transcript;
            firstAccuracy = accuracy;
            firstOutput.style.display = 'block';
            firstOutput.textContent = `æœ€åˆã®éŸ³èª­: ${transcript} (ä¸€è‡´åº¦ ${accuracy}%)`;
          } else {
            finalTranscript = transcript;
            finalAccuracy = accuracy;
            finalOutput.style.display = 'block';
            finalOutput.textContent = `æœ€å¾Œã®éŸ³èª­: ${transcript} (ä¸€è‡´åº¦ ${accuracy}%)`;
          }
          showImprovement();
        };
        recognition.onerror = (event) => {
          alert('éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error);
        };
        recognition.start();
      }

      function calculateAccuracy(expected, recognized) {
        const normalize = (str) =>
          str
            .toLowerCase()
            .replace(/[^a-z\s]/g, '')
            .split(/\s+/)
            .filter(Boolean);
        const expectedWords = normalize(expected);
        const recognizedWords = normalize(recognized);
        let matches = 0;
        expectedWords.forEach((w, i) => {
          if (recognizedWords[i] && recognizedWords[i] === w) matches++;
        });
        return Math.round((matches / expectedWords.length) * 100);
      }

      function showImprovement() {
        if (firstAccuracy !== null && finalAccuracy !== null) {
          improvement.style.display = 'block';
          const diff = finalAccuracy - firstAccuracy;
          const sign = diff >= 0 ? '+' : '';
          improvement.textContent = `æ”¹å–„åº¦: ${sign}${diff}% (æœ€åˆ ${firstAccuracy}%, æœ€å¾Œ ${finalAccuracy}%)`;
        }
      }

      // Render the selected lesson
      function renderLesson() {
        const idx = parseInt(lessonSelect.value);
        const lesson = LESSONS[idx];
        lessonTitle.textContent = lesson.title;
        sentencesEl.innerHTML = '';
        // Build expected text for accuracy calculations
        expectedText = lesson.sentences.map((s) => s.en).join(' ');
        firstTranscript = '';
        finalTranscript = '';
        firstAccuracy = null;
        finalAccuracy = null;
        firstOutput.style.display = 'none';
        finalOutput.style.display = 'none';
        improvement.style.display = 'none';
        // Render sentences
        lesson.sentences.forEach((sent) => {
          const div = document.createElement('div');
          div.className = 'sentence';
          const spanEn = document.createElement('span');
          spanEn.textContent = sent.en;
          const playBtn = document.createElement('button');
          playBtn.textContent = 'â–¶ï¸';
          playBtn.onclick = () => speak(sent.en);
          const spanJp = document.createElement('span');
          spanJp.className = 'translation';
          spanJp.textContent = sent.jp;
          div.appendChild(playBtn);
          div.appendChild(spanEn);
          div.appendChild(spanJp);
          sentencesEl.appendChild(div);
        });
        toggleTranslation.checked = false;
        toggleTranslations();
        renderVocab();
      }

      function toggleTranslations() {
        const show = toggleTranslation.checked;
        document.querySelectorAll('.translation').forEach((el) => {
          el.style.display = show ? 'inline' : 'none';
        });
      }

      function renderVocab() {
        const idx = parseInt(lessonSelect.value);
        const vocab = LESSONS[idx].vocab;
        const flipped = flipVocab.dataset.flipped === 'true';
        vocabTable.innerHTML = '';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        const th1 = document.createElement('th');
        const th2 = document.createElement('th');
        th1.textContent = flipped ? 'æ—¥æœ¬èª' : 'è‹±èª';
        th2.textContent = flipped ? 'è‹±èª' : 'æ—¥æœ¬èª';
        trh.appendChild(th1);
        trh.appendChild(th2);
        thead.appendChild(trh);
        vocabTable.appendChild(thead);
        const tbody = document.createElement('tbody');
        vocab.forEach((pair) => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          const td2 = document.createElement('td');
          td1.textContent = flipped ? pair[1] : pair[0];
          td2.textContent = flipped ? pair[0] : pair[1];
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);
        });
        vocabTable.appendChild(tbody);
      }

      function saveCsvFile() {
        const date = new Date().toISOString();
        const lesson = LESSONS[parseInt(lessonSelect.value)].title;
        const score = scoreInput.value || '';
        const rows = [
          ['date', 'lesson', 'score', 'first_transcript', 'first_accuracy', 'final_transcript', 'final_accuracy'],
          [date, lesson, score, firstTranscript, firstAccuracy ?? '', finalTranscript, finalAccuracy ?? ''],
        ];
        const csvContent = rows.map((r) => r.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `shadowing_score_${Date.now()}.csv`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function sendToForm() {
        const url = formUrl.value.trim();
        if (!url) {
          alert('Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        const data = new FormData();
        data.append('entry.lesson', LESSONS[parseInt(lessonSelect.value)].title);
        data.append('entry.score', scoreInput.value);
        data.append('entry.date', new Date().toISOString());
        data.append('entry.firstTranscript', firstTranscript);
        data.append('entry.firstAccuracy', firstAccuracy ?? '');
        data.append('entry.finalTranscript', finalTranscript);
        data.append('entry.finalAccuracy', finalAccuracy ?? '');
        fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          body: data,
        })
          .then(() => alert('ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸã€‚'))
          .catch(() => alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      }

      // Event listeners
      lessonSelect.addEventListener('change', renderLesson);
      toggleTranslation.addEventListener('change', toggleTranslations);
      flipVocab.addEventListener('click', () => {
        flipVocab.dataset.flipped = flipVocab.dataset.flipped === 'true' ? 'false' : 'true';
        renderVocab();
      });
      saveCsv.addEventListener('click', saveCsvFile);
      sendForm.addEventListener('click', sendToForm);
      firstReadBtn.addEventListener('click', () => recordReading('first'));
      finalReadBtn.addEventListener('click', () => recordReading('final'));
      shadowBtn.addEventListener('click', () => speakLesson(parseFloat(rateSlider.value)));
      overlapBtn.addEventListener('click', () => speakLesson(parseFloat(rateSlider.value)));

      // Initial render
      lessonSelect.value = 0;
      renderLesson();
    </script>
  </body>
</html>
